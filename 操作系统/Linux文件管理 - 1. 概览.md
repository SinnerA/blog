---
title: Linux文件管理 - 1. 概览
date: 2018-06-02
tags: Linux内核 文件管理
---

[TOC]

## 整体结构

什么样才算是一个文件系统？至少应该包含：

1. **数据存储：**对于任何一个文件系统来说，一个最主要的功能就是能够被当作一个结构化的容器来存储和获取数据
2. **命名空间：** 命名空间是一个提供了用于命名与组织数据的命名规则和数据结构的方法学
3. **安全模型：** 一个用于定义访问权限的策略
4. **API：** 操作这个系统的对象的系统功能调用，这些对象诸如目录和文件
5. **实现：** 能够实现以上几点的软件

### VFS

VFS（虚拟文件系统）作为Linux内核子系统，是一个处于用户进程和各类文件系统之间的抽象接口层。VFS提供了访问文件系统对象的通用对象模型（inode、目录、文件对象、页缓存等）和方法，他对用户隐藏了各种文件系统的差别。有了VFS，程序可以利用标准的系统调用对不同文件系统，甚至不同介质上的文件系统进行读写操作。

![Linux VFS](https://github.com/SinnerA/blog/tree/master/illustrations/VFS.png)

### 日志

系统执行写操作时，内核先修改文件元数据，然后写入文件系统，这个过程中如果系统出现故障可能会丢失数据。

日志文件系统解决了这个问题，在写入实际的文件系统之前，他先把要修改的数据写入一个叫做日志区域（journal area）的地方，写入日志区域的数据叫做日志记录（joutnal log）。记录日志会产生一定的开销。

> 日志区域可以在文件系统上，也可以不在。

![Linux journal log](https://github.com/SinnerA/blog/tree/master/illustrations/journal log.png)

### 数据存储

Linux支持各类文件系统，Ext2、Ext3、Ext4等是原生的Linux文件系统，将重点介绍下这几种文件系统。Linux最早的文件系统为 Ext2（Linux second extended file system，Ext2fs），之后又出现了改进版的 Ext3 和 Ext4 。

#### Ext2

对于Ext2文件系统来说，硬盘分区首先被划分为一个个的Block，一个Ext2文件系统上的每个Block都是一样大小的。但是不同Ext2文件系统，Block大小可能不同，这是在创建Ext2系统决定的，一般为1k或者4k。由于Block数量很多，为了方便管理，Ext2将这些Block聚集在一起分为几个大的块组（Block Group），每个块组包含的等量的物理块，在块组的数据块中存储文件或目录。

![ext2文件系统存储结构](https://github.com/SinnerA/blog/tree/master/illustrations/Ext2.png)

Ext2结构：

1. boot sector（引导扇区）：包含了非常小的引导记录和一个分区表

2. data blocks（柱面组），每个data block：

3. - super block（超级块）：记录整个partition的block和inode的总量，已使用和未使用的inode和block的数量，1个block和1个inode的大小，filesystem的挂载时间/最后写入时间/最后检查时间、标示该文件系统是否被挂载的valid bit（0标示未挂载，1标示已挂载）。是MBR中的Superblock的backup

   - GDT（Group Descriptor Table，块组描述符）：存储一个块组的描述信息，例如在这个块组中从哪里开始是Inode表，从哪里开始是数据块等等

   - block bitmaps：记录哪个block是空闲的

   - inode bitmaps：记录哪个inode是空闲的

   - inode table：存放inode数据

     > 为了节约inode的空间，Ext2将Inode记录Block号码的区域定义为12个直接、一个间接、一个双间接与一个三间接记录区，也就是多级索引。

   - data blocks：存放block数据

> 注意：Superblock, Inode, Dentry 和 File 都属于元数据(Metadata)，根据维基百科中的解释，所谓元数据，就是描述数据的数据（data about data），主要是描述数据属性（property）的信息，用来支持如指示存储位置、历史数据、资源查找、文件纪录等功能。Linux/Unix 文件系统的元数据以多级结构保存。

由于缺乏日志系统，EXT2 文件系统最大的问题是 `fsck` (文件系统检查) 程序这一环节占用了很长一段时间来定位和校准文件系统中的所有的不一致性，从而导致在系统崩溃crash后其会花费了数个小时来修复。

#### Ext3

EXT3文件系统是应一个目标而生的，就是克服 fsck 程序需要完全恢复在文件更新操作期间发生的不正确关机而损坏的磁盘结构所需的大量时间。它对EXT文件系统的唯一新增功能就是**日志**，它将提前记录将对文件系统执行的更改。 EXT3的磁盘结构的其余部分与EXT2中的相同。

EXT3上的日志会将文件数据随同元数据写入到磁盘上的一个指定数据区域。日志功能确实降低了数据写入性能，但是有三个可用于日志的选项：journal、ordered、writeback，允许用户在性能和数据完整性、安全性之间进行选择。 

EXT3 的日志功能可以关闭，然后其功能就等同于 EXT2 文件系统了。 该日志本身仍然是存在的，只是状态为空且未使用。 

#### Ext4

EXT4文件系统主要提高了**性能、可靠性和容量**。为了提高可靠性，它新增了元数据和日志校验和。同时为了满足各种关键任务要求，文件系统新增了纳秒级别的时间戳。

在 EXT4 中，数据分配从固定块改为**扩展盘区（extent）或称为段**方式，扩展盘区由硬盘驱动器上的开始和结束位置来描述。这使得可以在单个 inode 指针条目中描述非常长的物理上连续的文件，这可以显著减少描述大文件中所有数据的位置所需的指针数。其它在 EXT4 中已经实施的分配策略可以进一步减少碎片化。

…（待补充）

#### 其它

其他的文件系统还有XFS，Solaris ZFS以及Linux Btrfs，它们在实现上有很大的区别，比如动态inode分配等。

## 实现

### 目录

操作某个文件之前，需要找到对应的目录项，并找到inode信息，才能找到文件的物理位置。因此，目录项的检索速度很重要，目录的实现方式基本有线性列表和哈希表两种。

Linux中采用哈希链表的方式实现目录项，并且为了减少IO，目录项通常会缓存在内存中，提高检索速度。

### 文件

#### 分配方式

文件分配方式，就是如何分配磁盘块，常用的分配方式有：连续分配、链接分配和索引分配。

##### 连续分配

连续分配要求每个文件在磁盘上占有一组连续的块，目录中记录了start和end的block。

优缺点：

1. 实现简单，并有利于减少寻道时间，存取速度快
2. 文件长度不宜动态增加
3. 反复增删文件之后会产生外部碎片

##### 链接分配

链接分配采取离散的分配方式，消除了外部碎片。目录中记录了start和end，不过它们是通过指针关联的。

优缺点：

1. 提高了磁盘空间利用率
2. 文件的增删非常方便
3. 缺点在于只能通过指针顺序访问磁盘块，增加了IO次数

##### 索引分配

索引分配方式既解决了碎片问题，也解决了无法直接访问的问题。它把每个文件所有的盘块号都集中在一起构成索引块（表），目录中只需要记录该索引表的块号。

优缺点：

1. 解决了外部碎片和无法直接访问的问题
2. 索引块占用了磁盘空间

Linux中采用的就是这种方式，通常会将索引块缓存在内存中。

#### 存储管理

Linux中采用bitmap来表示磁盘中一个盘块的使用情况。

## 参考

[Linux 的 EXT4 文件系统的历史、特性以及最佳实践](https://linux.cn/article-8685-1.html)
